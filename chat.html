<!DOCTYPE html>
<html>

<head>
  <title>Chat</title>
  <script src="js/config.js"></script>
  <script src="js/chat_api.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .user_text {
      border: solid 1px lightseagreen;
      background-color: #eafaea;
      margin: 2px;
    }

    .ai_text {
      border: solid 1px rgb(69, 105, 212);
      background-color: #e7ecfe;
      margin: 2px;
    }

    .wait_indicator {
      background-color: #fbfbec;
      margin: 1px;
    }

    .input_form {
      margin: 3px;
    }
  </style>
</head>

<body>
  <div id="chat_history" style="border:sold black 1px">
    <div id="waiting" class="wait_indicator" style="display: none;">AI thinking...</div>
  </div>
  <div class="input_form">
    <form name="user_text" onsubmit="sendText(); return false">
      <input type="text" id="user_text" size="40" tabindex="1" ></input>
      <input type="submit" value="submit" tabindex="2" />
    </form>
  </div>
</body>
<script>
  // ==== UI elements ====
  const divChatHistory = document.getElementById('chat_history');
  const userText = document.getElementById('user_text');
  const divWaiting = document.getElementById('waiting');

  // ==== UI functions ====
  async function sendText() {
    const apiKey = API_KEY;

    const text = userText.value;
    addUserText(text);

    showWaiting(true);
    const response = await postChatText(text, apiKey);
    showWaiting(false);
    addResponseText(response.content);

    clearInput()
  }

  function clearInput() {
    userText.value = '';
  }

  function addUserText(text) {
    const div = document.createElement('div');
    div.className = 'user_text';
    div.innerHTML = 'user:' + text;
    //divChatHistory.appendChild(div);
    divChatHistory.insertBefore(div, divWaiting);
  }

  function addResponseText(text) {
    const div = document.createElement('div');
    div.className = 'ai_text';
    //div.innerHTML = 'AI:' + text;
    div.innerHTML = 'AI:<br/>' + marked.parse(text, { gfm: false });

    //divChatHistory.appendChild(div);
    divChatHistory.insertBefore(div, divWaiting);
  }

  function showWaiting(flag) {
    if (flag) {
      divWaiting.style.display = 'block';
    }
    else {
      divWaiting.style.display = 'none';
    }
  }

</script>

</html>