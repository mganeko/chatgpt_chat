<!DOCTYPE html>
<html>

<head>
  <title>Chat</title>
  <script src="js/config.js"></script>
  <script src="js/chat_api.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
  <div id="chat_history" style="border:sold black 1px">
    <div id="waiting" style="display: none;">AI thinking...</div>
  </div>
  <div>
    <form name="user_text" onsubmit="sendText(); return false">
      <input type="text" id="user_text" size="40" tabindex="1" ></input>
      <input type="submit" value="submit" tabindex="2" />
    </form>
  </div>
</body>
<script>
  const divChatHistory = document.getElementById('chat_history');
  const userText = document.getElementById('user_text');
  const divWaiting = document.getElementById('waiting');


  async function sendText() {
    const apiKey = API_KEY;

    const text = userText.value;
    addUserText(text);

    showWaiting(true);
    const response = await postText(text, apiKey);
    showWaiting(false);
    addResponseText(response.content);

    clearInput()
  }

  function clearInput() {
    userText.value = '';
  }

  function addUserText(text) {
    const div = document.createElement('div');
    div.innerHTML = 'user:' + text;
    //divChatHistory.appendChild(div);
    divChatHistory.insertBefore(div, divWaiting);
  }

  function addResponseText(text) {
    const div = document.createElement('div');
    //div.innerHTML = 'AI:' + text;
    div.innerHTML = 'AI:<br/>' + marked.parse(text, { gfm: false });

    //divChatHistory.appendChild(div);
    divChatHistory.insertBefore(div, divWaiting);
  }

  function showWaiting(flag) {
    if (flag) {
      divWaiting.style.display = 'block';
    }
    else {
      divWaiting.style.display = 'none';
    }
  }

</script>

</html>